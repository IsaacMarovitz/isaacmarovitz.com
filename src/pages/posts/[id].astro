---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/footer.astro";
import { getCollection, render } from 'astro:content';
import BlogNav from "../../components/blog-nav.astro";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map(post => ({
    params: { id: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const options: Intl.DateTimeFormatOptions = {
    year: "numeric",
    month: "long",
    day: "numeric",
    timeZone: "UTC"
}

var dateString = post.data.pubDate.toLocaleDateString("en-GB", options);
const ogImageUrl = new URL(Astro.url.pathname + "og.png", Astro.site).href;
---

<Layout title=`Isaac Marovitz - ${post.data.title}` description={post.data.description}>
    <Fragment slot="meta">
        <meta property="og:title" content={post.data.title} />
        <meta property="og:description" content={post.data.description} />
        <meta property="og:url" content={Astro.url.href} />
        <meta property="og:type" content="article" />
        <meta property="og:image" content={ogImageUrl} />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="article:author" content="Isaac Marovitz" />
        <meta property="article:published_time" content={post.data.pubDate.toISOString()} />
        {
            post.data.tags.map((tag: string) => (
                <meta property="article:tag" content={tag} />
            ))
        }
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:title" content={post.data.title} />
        <meta property="twitter:description" content={post.data.description} />
        <meta property="twitter:url" content={Astro.url.href} />
        <meta property="twitter:image" content={ogImageUrl} />
    </Fragment>
    <div class="flex justify-center">
        <div class="flex flex-col min-h-screen min-w-0 max-w-4xl">
            <div class="flex flex-col max-[1400px]:px-5 grow">
                <div class="flex flex-col items-start text-left pt-10 gap-3">
                    <BlogNav allPosts={true} />
                    <div class="flex flex-col gap-2">
                        <h1 class="font-extrabold text-2xl sm:text-5xl lg:text-5xl">
                            {post.data.title}
                        </h1>

                        <p>{post.data.description}</p>
                        <p class="text-secondary">Published {dateString}</p>
                        <div class="flex flex-row gap-2 items-center flex-wrap">
                        {
                            post.data.tags.map((tag: string, index: number) => (
                                <a href={`/tags/${tag}`}>
                                    <div class="flex">
                                        <p class="text-accent hover:underline">{tag}</p>
                                        {index < post.data.tags.length - 1 && <p>,</p>}
                                    </div>
                                </a>
                            ))
                        }
                        </div>
                    </div>
                </div>
                <div class="py-5">
                    <hr />
                </div>
                <div class="flex justify-center">
                    <div class="flex flex-col gap-5 prose prose-invert prose-stone min-w-0 max-w-4xl">
                        <Content />
                    </div>
                </div>
                <div class="grow" />
                <Footer />
            </div>
            <div class="zoom-overlay"><img alt="Zoom overlay"/></div>
        </div>
    </div>
</Layout>

<script>
    function isDesktop() {
        return window.matchMedia("(pointer: fine)").matches;
    }

    function zoomImage(overlay: Element, img: HTMLImageElement) {
        overlay.querySelector("img")!.src = img.currentSrc || img.src;
        overlay.classList.add("active");
        document.body.style.overflow = "hidden";
    }

    function unzoomImage(overlay: Element) {
        overlay.classList.remove("active");
        document.body.style.overflow = "";
    }

    document.addEventListener("click", (e: Event) => {
        if (!isDesktop()) {
            return;
        }

        const overlay = document.querySelector(".zoom-overlay");
        const img = (e.target as HTMLElement).closest(".zoomable-img");

        if (img) {
            zoomImage(overlay!, img as HTMLImageElement);
            return;
        }

        if (overlay!.classList.contains("active")) {
            unzoomImage(overlay!);
        }
    });

    document.addEventListener("keydown", (e: KeyboardEvent) => {
        const overlay = document.querySelector(".zoom-overlay");

        if (e.key === "Escape" && overlay!.classList.contains("active")) {
            unzoomImage(overlay!);
        }
    });
</script>
